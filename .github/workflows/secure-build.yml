name: Secure Build

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: meluansantos/secure-pipeline-poc

jobs:
  secure-build:
    name: Build Hardenado com gVisor
    runs-on: self-hosted
    
    container:
      image: ubuntu:22.04
      options: >-
        --runtime=runsc
        --security-opt=no-new-privileges:true
        --cap-drop=ALL
        --cap-add=NET_BIND_SERVICE
        --read-only
        --tmpfs /tmp:rw,noexec,nosuid
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout código (modo seguro)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Verificar isolamento gVisor
        run: |
          echo "Verificando ambiente de execução..."
          
          if dmesg 2>/dev/null | grep -q "gVisor"; then
            echo "Executando dentro do gVisor sandbox"
          else
            echo "gVisor pode não estar ativo - verifique a configuração do runner"
          fi
          
          echo "Usuário atual: $(whoami)"
          echo "UID: $(id -u), GID: $(id -g)"
          
          echo "Capabilities:"
          cat /proc/self/status | grep Cap || echo "Sem acesso a capabilities"
      
      - name: Execução limitada como usuário não-root
        run: |
          if ! id -u runner &>/dev/null; then
            useradd -m -s /bin/bash runner || true
          fi
          
          echo "Iniciando build em ambiente isolado..."
          
          sudo -u runner bash -c '
            echo "Compilando dentro de gVisor sandbox..."
            echo "PWD: $(pwd)"
            echo "USER: $(whoami)"
            
            echo "Ambiente de build validado"
          ' || echo "Usando usuário atual"
      
      - name: Teste de isolamento - Syscalls bloqueadas
        run: |
          echo "Testando bloqueio de syscalls perigosas..."
          
          set +e
          
          mount -t tmpfs none /mnt 2>&1 && echo "FALHA: mount não bloqueado" || echo "mount bloqueado"
          
          cat /dev/mem 2>&1 && echo "FALHA: /dev/mem acessível" || echo "/dev/mem inacessível"
          
          modprobe dummy 2>&1 && echo "FALHA: modprobe não bloqueado" || echo "modprobe bloqueado"
          
          set -e
          echo "Testes de isolamento concluídos"
      
      - name: Build da aplicação
        run: |
          echo "Executando build da aplicação..."
          
          
          echo "Build concluído com sucesso"

  secure-build-fallback:
    name: Build com Restrições (Fallback)
    runs-on: ubuntu-latest
    if: ${{ failure() || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Build com restrições de segurança
        run: |
          echo "Executando em runner GitHub-hosted (sem gVisor)"
          echo "Aplicando restrições alternativas..."
          
          docker run --rm \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid \
            --network=none \
            -v "$(pwd):/workspace:ro" \
            -w /workspace \
            alpine:3.19 \
            sh -c '
              echo "Build em container restrito..."
              echo "Build concluído"
            '

  runtime-audit:
    name: Auditoria de Runtime
    runs-on: ubuntu-latest
    needs: [secure-build-fallback]
    if: always()
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Verificar configurações de segurança
        run: |
          echo "Auditoria de configurações de runtime..."
          
          if [ -S /var/run/docker.sock ]; then
            echo "AVISO: docker.sock está acessível"
            echo "Recomendação: Configure runners self-hosted com gVisor"
          else
            echo "docker.sock não está exposto neste contexto"
          fi
          
          echo ""
          echo "Informações do processo:"
          echo "User: $(whoami)"
          echo "Groups: $(groups)"
          
          echo ""
          echo "Auditoria concluída"
