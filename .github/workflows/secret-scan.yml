name: Scan de Secrets

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, develop]

jobs:
  scan:
    name: Detectar Secrets
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Instalar Gitleaks
        run: |
          GITLEAKS_VERSION="8.18.4"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar xz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
      
      - name: Executar Gitleaks - Detectar secrets
        run: |
          echo "Iniciando scan de secrets com Gitleaks..."
          gitleaks detect \
            --source=. \
            --redact \
            --exit-code=1 \
            --report-format=sarif \
            --report-path=gitleaks-report.sarif \
            --verbose
        continue-on-error: false
      
      - name: Upload SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-report.sarif
          category: gitleaks
      
      - name: Scan de commits recentes (baseline)
        if: github.event_name == 'pull_request'
        run: |
          echo "Verificando commits do PR..."
          gitleaks detect \
            --source=. \
            --log-opts="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}" \
            --redact \
            --exit-code=1 \
            --verbose 2>&1 | head -100 || {
              echo "SECRETS DETECTADOS! PR bloqueado."
              echo "Por favor, remova os secrets antes de fazer merge."
              exit 1
            }
      
      - name: Verificação de padrões customizados
        run: |
          echo "Verificando padrões customizados de secrets..."
          
          if find . -type f \( -name "*.yml" -o -name "*.yaml" -o -name "*.json" -o -name "*.env" \) \
             -not -path "./.git/*" -not -path "./.github/*" \
             -exec grep -lE "(PRIVATE_KEY|BEGIN RSA|BEGIN OPENSSH|password\s*=\s*['\"][^'\"]+['\"])" {} \; 2>/dev/null | head -1 | grep -q .; then
            echo "Padrões suspeitos encontrados!"
            find . -type f \( -name "*.yml" -o -name "*.yaml" -o -name "*.json" -o -name "*.env" \) \
               -not -path "./.git/*" -not -path "./.github/*" \
               -exec grep -lE "(PRIVATE_KEY|BEGIN RSA|BEGIN OPENSSH|password\s*=\s*['\"][^'\"]+['\"])" {} \; 2>/dev/null
            exit 1
          fi
          
          echo "Nenhum padrão suspeito encontrado"
